---
title: "Eric_Hirsch_607_Assignment_5"
author: "Eric Hirsch"
date: "`r Sys.Date()`"
output: 
  tufte::tufte_html: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-packages, message=FALSE}
#install.packages('RCurl')
library(openintro)
library(tinytex)
library(tidyverse)
library(stringr)
library(magrittr)
library(gridExtra)
library(tufte)
library(knitr)
library(ggthemes)
library(extrafont)
#font_import()
loadfonts()
```

## Using TidyR and Dyplr for Data Transformation

In this project we will transform a csv file into a usable dataframe using TidyR and Dyplr. After the transformation we will conduct some analyses.

First we load the data ... 

``` {r load data}
dfFlights_raw <- as.data.frame(read.delim("https://raw.githubusercontent.com/ericonsi/CUNY_607/main/Projects/Project%202/Flights.csv", header = TRUE, stringsAsFactors = TRUE, sep=","))
```

... eliminate the unnecessary rows, and change some column names:

```{marginfigure, echo=TRUE}

Principle 1. Separate Data from Metadata: 
```

```{marginfigure, echo=TRUE}  
There is a table to the left. If I wanted to make comments about that table, I could do it here.  We often have data, and then information about the data. This column, a mainstay of Tufte presentation, is a place to present this metadata.

```

```{r bvkf}
dfFlights <- dfFlights_raw %>% 
  drop_na(Phoenix) %>%
  rename(c(Airline =  "X", Status = "X.1")) %>%
  mutate_all(list(~na_if(.,"")))

kable(head(dfFlights))
```


  
Now we use TidyR to normalize the table - this is an extremely powerful library that does a lot in a couple lines ...

```{r agfd}

dfFlights %<>%
  gather("Los.Angeles", "Phoenix", "San.Diego", "San.Francisco", "Seattle", key="City", value="NumOfFlights") %<>%
  fill(Airline)
```

... and that's all it takes!

## Analysis of Delays

Now we can analyse the airline's delays.  We start with the mean delay percentage (flights delayed over total flights) for each airline.  Amwest appears to have a better track record than Alaska.

```{marginfigure, echo=TRUE}

Principle 2. Increase the Data-Ink Ratio! 

```


```{marginfigure, echo=TRUE}
This boxplot is great for analysis ...
```

```{r dfs}
dfSummaryStats <- dfFlights %>% 
  group_by(Airline, City) %>% 
  summarize(sum_DelayedFlights=sum(NumOfFlights[Status=="delayed"]), sum_Flights = sum(NumOfFlights), propOfDelay=sum(NumOfFlights[Status=="delayed"])/sum(NumOfFlights)*100)

dfSummaryStats2 <- dfFlights %>% 
  group_by(Airline) %>% 
  summarize(sum_DelayedFlights=sum(NumOfFlights[Status=="delayed"]), sum_Flights = sum(NumOfFlights), propOfDelay=sum(NumOfFlights[Status=="delayed"])/sum(NumOfFlights)*100)

dfDelaysOnly <- dfFlights %>%
  filter(Status=="delayed")

dfDelaysOnly_Amwest <- dfDelaysOnly %>%
  filter(Airline=="AMWEST")

dfDelaysOnly_Alaska <- dfDelaysOnly %>%
  filter(Status=="ALASKA[")

dfPercentDiff <- dfSummaryStats %>%
  select(Airline, City, propOfDelay) %>%
  group_by(City) %>%
  summarize(propDiff=propOfDelay[Airline=="AMWEST"] - propOfDelay[Airline=="ALASKA"])

```

```{r boxplot}

gg2 <-ggplot(dfSummaryStats, aes(reorder(City, propOfDelay), propOfDelay)) +
geom_boxplot() + theme(axis.text.x = element_text(angle = 90), axis.title = element_text(size=15), axis.text = element_text(size = 15), plot.title = element_text(size=18)) +
  ggtitle("Percentage of Delayed Flights by City") +
  ylab("Percentage of Flights Delayed") +
  xlab("City") + 
  coord_flip()
gg2
```

```{marginfigure, echo=TRUE}

... but this is cleaner, leaner and perhaps clearer for a presentation.

```

```{r b2}

gg1 <- ggplot(dfSummaryStats, aes(reorder(City, propOfDelay), propOfDelay)) + theme_tufte() +
geom_tufteboxplot(outlier.colour="transparent") + theme(axis.title=element_blank(), axis.text.x = element_text(angle = 0), axis.text = element_text(size = 20), plot.title = element_text(size=20), axis.ticks=element_blank()) +
annotate("text", x = 0, y =30, adj=0,  family="Gill Sans MT", label = "") +
  ggtitle("Percentage of Delayed Flights by City") + 
  coord_flip()
gg1

```

Here are the numbers showing proportion of delayed flights per airline:

```{r mean}

kable(dfSummaryStats2)

```
```{marginfigure, echo=TRUE}

Principle 3. Placement Matters 

```

```{marginfigure, echo=TRUE}
Here we move a chart to the side column.
```



```{r bar, fig.margin=TRUE}
ggplot(dfSummaryStats, aes(x=reorder(City, propOfDelay), y=propOfDelay, group=Airline, fill=Airline)) +
  geom_col(position = position_dodge()) +
  theme(axis.text = element_text(size = 20), axis.title=element_text(size=20), legend.text = element_text(size=20), legend.title = element_text(size=20), plot.title = element_text(size=20)) +
  ylab("City") + 
  xlab("Percentage of Delays") +
    ggtitle("Percent Delays by City and Airline") +
  coord_flip()
```

```{marginfigure, echo=TRUE}


```

```{marginfigure, echo=TRUE}
We can improve this chart according to Tufte by erasing what we don't need:
```
However, when we look at the percentage of delayed flights by city, Alaska is the clear winner, beating Amwest in every city (Fig 1.).

How is this possible?


```{r xyz, fig.margin=TRUE, fig.cap="Fig.1: Percent delays by city and airline"}

ggplot(dfSummaryStats, aes(x=reorder(City, propOfDelay), y=propOfDelay, group=Airline, fill=Airline)) + theme_tufte(base_size=14, ticks=F) +
  geom_bar(position = position_dodge(), width=0.3, stat = "identity") +  theme(axis.title=element_blank()) +
  annotate("text", x = 3.5, y = 5, adj=1,  family="Gill Sans MT",
label = "") +
    theme(axis.text.x = element_text(angle = 0), axis.text = element_text(size = 24 , family="Gill Sans MT"), legend.text = element_text(size=20), legend.title=element_blank()) +
  coord_flip()

```

If we look at the distribution of delay % by city, we can see that although Alaska beats Amwest when they are head to head in a city, in fact some of the % delays for Amwest are lower than some of those for Alaska. And Amwest's delay percentage is at its lowest in a city that has a highly disproportionate number of Amwest flights (Phoenix). This is going to bring the overall mean % of Amwest's delays way down:

```{r paradox}
kable(dfSummaryStats)
```

Is there anything in the data that might explain Amwest's poorer per city performance relative to Alaska's (besides incompetence, priority or some other reason internal to Amwest)? There is not much data to work with, but one difference might be the level of traffic - maybe the larger (or smaller) an airline is, the higher its delay percentage is.  

These graphs display the percentage of delays by total flights for each airline.  The second one has two outliers removed:

```{marginfigure, echo=TRUE}

Principle 4. Break up the Hegemony of the Monolithic Chart

```

```{marginfigure, echo=TRUE}
Here we use mini-charts in the form of sparklines to show total flights over time for a number of airlines.
```
```{r llg, fig.margin=TRUE}


library(reshape)
library(RCurl)
library(extrafont)
#font_import()
#loadfonts(device = "win")


dfFlightYears <- read_csv("D:\\RStudio\\CUNY_607\\Assigments\\Assignment 5 - Tufte\\FileForSlopeGraph.csv")
dfFlightYears %<>%
  gather("Alaska", "Amwest", "British", "Continental", "Delta", "Eastern", "Hawaiian", key="airline", value="flights")  %<>%
  mutate(flights=as.integer(flights))


dfFlightYears %<>%
  mutate(yearCat = as.character(as.integer(Year/10)*10))

dfFl <- dfFlightYears %>%
  group_by(airline, yearCat) %>%
  summarize(Flights=round(mean(flights)))

d <- dfFlightYears
mins <- group_by(d, airline) %>% slice(which.min(flights))
maxs <- group_by(d, airline) %>% slice(which.max(flights))
ends <- group_by(d, airline) %>% filter(Year == max(Year))
quarts <- d %>% group_by(airline) %>%
  summarize(quart1 = quantile(flights, 0.25),
            quart2 = quantile(flights, 0.75)) %>%
  right_join(d)

ggplot(d, aes(x=Year, y=flights)) + 
  facet_grid(airline ~ ., scales = "free_y") + 
  geom_line(size=0.7) +
  geom_text(data = ends, aes(label = airline), hjust = 0, nudge_x = 8, size=8, family="Gill Sans MT") +
  expand_limits(x = max(d$Year) + (0.7 * (max(d$Year) - min(d$Year)))) +
  scale_x_continuous(breaks = seq(1960, 2010, 10)) +
  scale_y_continuous(expand = c(0.2, 0)) +
  theme_tufte() +
  theme(axis.title=element_blank(), axis.text = element_blank(), 
        axis.ticks = element_blank(), strip.text = element_blank()) +
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA))
```

```{marginfigure, echo=TRUE}
In R we can put more data into a sparkline if we want to.  Here we see IQR and min/max graphed onto a sparkline:
```

```{marginfigure, echo=TRUE}


```

```{r llout, fig.margin=TRUE}


library(reshape)
library(RCurl)
library(extrafont)
#font_import()
#loadfonts(device = "win")

d <- dfFlightYears
mins <- group_by(d, airline) %>% slice(which.min(flights))
maxs <- group_by(d, airline) %>% slice(which.max(flights))
ends <- group_by(d, airline) %>% filter(Year == max(Year))
begins <- group_by(d, airline) %>% filter(Year == min(Year))
quarts <- d %>% group_by(airline) %>%
  summarize(quart1 = quantile(flights, 0.25),
            quart2 = quantile(flights, 0.75)) %>%
  right_join(d)

ggplot(d, aes(x=Year, y=flights)) + 
  facet_grid(airline ~ ., scales = "free_y") + 
  geom_ribbon(data = quarts, aes(ymin = quart1, max = quart2), fill = 'grey90') +
  geom_line(size=0.7) +
  geom_point(data = mins, col = 'forestgreen', size=5) +
  geom_point(data = maxs, col = 'blue', size = 5) +
  geom_text(data = mins, aes(label = flights), vjust = -1, size=6, family="Gill Sans MT", col='forestgreen') +
  geom_text(data = maxs, aes(label = flights), vjust = 2.5, size=6, family="Gill Sans MT", col="blue") +
  #geom_text(data = ends, aes(label = flights), hjust = 0, nudge_x = 1, size=6, family="Gill Sans MT", col='red') +
  geom_text(data = ends, aes(label = airline), hjust = 0, nudge_x = 8, size=8, family="Gill Sans MT", col='black') +
  #geom_text(data = begins, aes(label = flights), hjust = 0, nudge_x = -1, size=6, family="Gill Sans MT", col='red') +
  expand_limits(x = max(d$Year) + (.5 * (max(d$Year) - min(d$Year)))) +
  scale_x_continuous(breaks = seq(1960, 2010, 10)) +
  scale_y_continuous(expand = c(.5, 0)) +
  theme_tufte() +
  theme(axis.title=element_blank(), axis.text.y = element_blank(), 
        axis.ticks = element_blank(), strip.text = element_blank(), axis.text = element_text(size = 14, family="Gill Sans MT")) +
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA))
```
xxx
```{r size}

g4<-ggplot(dfSummaryStats, aes(x=sum_Flights, y=propOfDelay)) +
  geom_point() +
  ggtitle("% of Delays By Total Flights") 


dfSummaryStats_OutliersRemoved <- dfSummaryStats %>%
  filter(sum_Flights<2000)

g5<-ggplot(dfSummaryStats_OutliersRemoved, aes(x=sum_Flights, y=propOfDelay)) +
  geom_point() +
  ggtitle("% of Delays By Total Flights _ outliers removed") 

grid.arrange(g4, g5, ncol=2)
```

```{r regression}

lmHeight = lm(sum_Flights~propOfDelay, data = dfSummaryStats_OutliersRemoved) #Create the linear regression
summary(lmHeight) #Review the results


```

Neither of the graphs nor the regression analysis that follows suggest that % of delays is correlated with number of flights.  

Perhaps it's something more sinister.  Is it possible there is some kind of favoritism going on among airport staff and crew?  There is no easy way to measure that directly, but as an albeit weak proxy we observe that Phoenix appears to be some kind of hub for Amwest and Seattle a hub for Alaska:

```{r traffic}

g3<-ggplot(dfFlights, aes(x=City, y=NumOfFlights, group=Airline, fill=Airline)) +
  geom_col(position = position_dodge()) +
  ggtitle("Number of Flights By Airline By City") +
  theme(axis.text.x = element_text(angle = 90))
g3
```

While Amwest has a higher percentage of delays across the board, is the gap between Amwest's and Alaska's delay percentages lowest in Phoenix and highest in Seattle?  This might suggest that where Amwest is most prominent they get favored treatment by the airport, and where Alaska is most prominent Amwest gets the least favored treatment.


This barchart shows the difference in the % delays between the two airlines, by city.  


```{r gv}

  
#install.packages('devtools')
#library(devtools)
#install_github("leeper/slopegraph")#install Leeper's package from Github
library(slopegraph)
ggslopegraph2(dataframe = dfFl,
                times = yearCat,
                measurement = Flights,
                grouping = airline,
                title = NULL,
                caption = NULL,
                linecolor = "gray",
                subtitle = NULL, 
                linethickness = .5,
                ytextsize = 3
                )

```

Note the footnote displayed to the right of me! ^[This is a footnote.]


Amwest clearly does best in Phoenix relative to Alaska, and very poorly in Seattle.  However, the biggest difference between the two is in San Francisco where Amwest has MORE total flights than Alaska. 

Perhaps it is the weather. Amwest does worst in the Northern cities - but at this point there is too little data to determine anything more than anecdotal.  Besides, blaming it on the weather, while we have all done it, is hardly a viable excuse.

## Conclusion

Amwest filed for bankruptcy in the early ninieties and eventually was swallowed up by US Air. This is a prophetic story.  Had they employed data scientists who could have shown them the above charts they might have survived to this day.
