library(stringr)
library(knitr)

#https://rpubs.com/fandang/164521

```{r}

get_indeed_url <- function(skill, base_term, city, radius){
  indeed_url <- paste("http://www.indeed.com/jobs?q=",trimws(skill),"+",trimws(base_term),"&l=",city,"&radius=",radius, sep = "")
  return (indeed_url)
}

get_count <- function(indeed_url){
  web_page <- readLines(indeed_url)
  
  count_str <- grep("Jobs 1 to [[0-9] of ([[0-9])", web_page, value=TRUE)
  count_str <- gsub(".*(Jobs 1 to [[0-9] of )","",count_str)
  count_str <- gsub("(</div>).*","",count_str)
  if(length(count_str) == 0){
    count_str <- 0
  }
  
  return (count_str)
}

write_indeed_results <- function(base_terms_list, skill_terms, cities, radius_list){
  
  grid <- expand.grid(base_terms_list, skill_terms, cities, radius_list)
  dfx <- data.frame(grid)
  colnames(dfx) <- c("Base_Term","Skill_Term","City","radius")
  
  
  dfx$indeed_url <- mapply(get_indeed_url, dfx$Skill_Term, dfx$Base_Term, dfx$City, dfx$radius)
  dfx$new_jobs_count <- mapply(get_count, dfx$indeed_url)
  
  write.csv(dfx, file = "D:\\RStudio\\CUNY_607\\Projects\\Project 3\\Indeed_Data_Science_Job_Search_Results.csv", row.names = FALSE, na = "")

  
  kable(head(dfx, n = 20))  
}

go <- function(){
  base_terms <- c('Data Scientist','Data Analytics')
  skill_terms.df <- read.csv("D:\\RStudio\\CUNY_607\\Projects\\Project 3\\IndeedDataScienceSkillsList.SUBSET.csv", header = TRUE)
  skill_terms <- trimws(skill_terms.df$SKILL)
  head(skill_terms.df)
  
  cities.df <- read.csv("D:\\RStudio\\CUNY_607\\Projects\\Project 3\\IndeedDataScienceCitiesList.SUBSET.csv", header = TRUE)
  cities <- paste(trimws(cities.df$CITY), trimws(cities.df$STATE), sep=",")
  head(cities)
  
  radius_list <- c(25,50)
  
  write_indeed_results(trimws(base_terms), trimws(skill_terms), trimws(cities), trimws(radius_list))
}

go()
dfFinal <- read.csv("D:\\RStudio\\CUNY_607\\Projects\\Project 3\\Indeed_Data_Science_Job_Search_Results.csv")
  
```