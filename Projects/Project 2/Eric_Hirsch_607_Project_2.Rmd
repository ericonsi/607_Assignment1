---
title: "Eric_Hirsch_607_Assignment_5"
author: "Eric Hirsch"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, message=FALSE}
library(openintro)
library(tinytex)
library(tidyverse)
library(stringr)
library(magrittr)
library(gridExtra)
library(readxl)
```

## Using TidyR and Dyplr for Data Transformation

#### Introduction 

In this project we will transform a csv file into a usable dataframe using TidyR and Dyplr. After the transformation we will conduct some analyses.

First we load the data: 

``` {r load data}
dfBLS_raw <- read_excel("D:\\RStudio\\CUNY_607\\Projects\\Project 2\\bls-2015.xlsx", "cpsaat17")
```
A. Headers are no good
B. How to separate out the demographic sections
C. Need to create "other" for race

1. Drop the totals column

```{r drop totals column}

dfBLS <- dfBLS_raw %>%
  select(-"...2")
```

2. Add the year

```{r add year}

dfBLS %<>%
  mutate(Year = "2015") 
```

3. Fix the column names
  a. Get a vector for the column names from the row tht contains them
  b. Clean the column names by replacing the hyphens
  c. rename the columns using the vector

```{r columns}

vColumnNames <- as.character(dfBLS %>%
  filter(row_number() %in% 5) %>%
  select(-starts_with("House") & -"Year"))

vColumnNames = str_replace_all(vColumnNames, "[\r\n]", " ")
vColumnNames = str_replace_all(vColumnNames, "-  ", "")
vColumnNames = str_replace_all(vColumnNames, " occupations", "")

dfBLS %<>%
  rename(Industry = starts_with("House"), !!vColumnNames[1] := ...3, !!vColumnNames[2] := ...4, !!vColumnNames[3] := ...5, !!vColumnNames[4] := ...6, !!vColumnNames[5] := ...7, !!vColumnNames[6] := ...8, !!vColumnNames[7] := ...9, !!vColumnNames[8] := ...10, !!vColumnNames[9] := ...11, !!vColumnNames[10] := ...12, !!vColumnNames[11] := ...13)
```

4. Extract the data into the 5 demographic units (female, male, Black, white and asian)
  a. select rows using 'filter'
  b. add the relevant demographic info as a column (.e.g Gender or Race)
  c. Handling rows which merely summarize other rows
    1. Remove the summary row
    s. Rename the remaining rows where necessary
  c. gather columns(using handy vector names column) to convert from wide to long
 

```{r filter into demographic units}

DemographicUnit <- function(df, rowStart, rowEnd, demoCategory, demoContent)
{
dfNew <- df %>% 
  filter(row_number() %in% rowStart:rowEnd) %>%
  mutate(!!demoCategory := demoContent) %>%
  filter(Industry !="Manufacturing" & Industry !="Wholesale and retail trade" & Industry !="Other services") %>%
  gather(vColumnNames,  key="Occupation", value="NumberEmployed") %>%
    mutate_at(vars(NumberEmployed), list(as.numeric)) %>%
  mutate(RowID = row_number())

dfNew$Industry = str_replace_all(dfNew$Industry, "Durable goods", "Manufacturing, durable goods")
dfNew$Industry = str_replace_all(dfNew$Industry, "Nondurable goods", "Manufacturing, nondurable goods")
dfNew$Industry = str_replace_all(dfNew$Industry, "Private households", "Other services, private households only")

return (dfNew)
}

dfBLS_Men = DemographicUnit(dfBLS, 29, 47, "Gender", "Male")
dfBLS_Women = DemographicUnit(dfBLS, 50, 68, "Gender", "Female")
dfBLS_White = DemographicUnit(dfBLS, 71, 89, "Race", "White")
dfBLS_Black = DemographicUnit(dfBLS, 92, 110, "Race", "Black")
dfBLS_Asian = DemographicUnit(dfBLS, 113, 131, "Race", "Asian")
dfBLS_Total = DemographicUnit(dfBLS, 8, 26, "Race", "Total")

  
```
5. Create the Race and Gender dataframes:

```{r cr}
dfRace <- rbind(dfBLS_Black, dfBLS_White, dfBLS_Asian, dfBLS_Total)
dfGender <- rbind(dfBLS_Women, dfBLS_Men)

```


6. Create the "Other Race" unit within the race dataframe by comparing the three race units to the total
  a. spread the dataframe using TidyR so each race is a column
  b. Create a category called "Other" which is the Total minus the other categories
  b. Eliminate the total category
  c. Re-gather the dataframe by race
  

```{r Other Race}

dfRace %<>% 
  spread(Race, NumberEmployed) %<>%
  mutate_at(vars(Black, White, Asian, Total), list(as.numeric)) %<>%
  mutate(Other = Total-(Black + White + Asian)) %<>%
  select(-"Total") %<>%
  gather(Black, White, Asian, Other, key="Race", value="NumberEmployed")

```

## Analysis

```{r}
g3<-ggplot(dfGender, aes(x=Industry, y=NumberEmployed, group=Gender, fill=Gender)) +
  geom_col(position = position_dodge()) +
  ggtitle("Number Employed by Industry and Gender") +
  theme(axis.text.x = element_text(angle = 90)) +
  coord_flip()
g3


```
```{r}

dfInfo=dfGender %>%
  filter(Industry=="Information" & NumberEmployed>100)
dfInfoRace=dfRace %>%
  filter(Industry=="Information" & NumberEmployed>100)

  g3<-ggplot(dfInfo, aes(x=Occupation, y=NumberEmployed, group=Gender, fill=Gender)) +
  geom_col(position = position_dodge()) +
  ggtitle("Number Employed in Information by Gender") +
    coord_flip()
  
g3  
    g4<-ggplot(dfInfoRace, aes(x=Occupation, y=NumberEmployed, group=Race, fill=Race)) +
  geom_col(position = position_dodge()) +
  ggtitle("Number Employed in Information by Race") +
  theme(axis.text.x = element_text(angle = 90)) 
g4
```


Now we can analyse the airlines delays.  We start by getting a look at the median and spread of delays for each airline.  We can also look at the delay percentage by city (delays over total flights) which might be more meaningful:

```{r boxplots}
dfSummaryStats <- dfFlights %>% 
  group_by(Airline, City) %>% 
  summarize(ave_Flights=mean(NumOfFlights), sum_Flights = sum(NumOfFlights), propOfDelay=sum(NumOfFlights[Status=="delayed"])/sum(NumOfFlights)*100)
             
dfDelaysOnly <- dfFlights %>%
  filter(Status=="delayed")

dfDelaysOnly_Amwest <- dfDelaysOnly %>%
  filter(Airline=="AMWEST")

dfDelaysOnly_Alaska <- dfDelaysOnly %>%
  filter(Status=="ALASKA[")

dfPercentDiff <- dfSummaryStats %>%
  select(Airline, City, propOfDelay) %>%
  group_by(City) %>%
  summarize(propDiff=propOfDelay[Airline=="AMWEST"] - propOfDelay[Airline=="ALASKA"])
  

g1 <- ggplot(dfDelaysOnly, aes(x=Airline, y=NumOfFlights)) +
  geom_boxplot() +
  ggtitle("Total Delays By Airline")

g2 <- ggplot(dfSummaryStats, aes(x=Airline, y=propOfDelay)) +
  geom_boxplot() +
  ggtitle("Percentage Delays By Airline By City")

grid.arrange (g1, g2, ncol=2)
  
```

Amwest has a higher median total delayed flights and a higher median percentage of delays per city. Might this be due to an outlier city which is skewing the results?  Apparently not, as this bar chart shows.

```{r bar}

g3<-ggplot(dfDelaysOnly, aes(x=City, y=NumOfFlights, group=Airline, fill=Airline)) +
  geom_col(position = position_dodge()) +
  ggtitle("Number of Delays By Airline By City") +
  theme(axis.text.x = element_text(angle = 90))


g4<-ggplot(dfSummaryStats, aes(x=City, y=propOfDelay, group=Airline, fill=Airline)) +
  geom_col(position = position_dodge()) +
  ggtitle("% of Delays By Airline By City") +
  theme(axis.text.x = element_text(angle = 90))


grid.arrange (g3, g4, ncol=2)
```

Amwest has a higher % of delays for every city.  

So is there anything in the data that might explain this (besides incompetence, priority or some other reason internal to Amwest?  One difference might be the level of traffic - maybe the larger (or smaller) an airline is, the higher its delay percentage is.  

These graphs display the percentage of delays by total flights for each airline.  The second one has two outliers removed:

```{r size}

g4<-ggplot(dfSummaryStats, aes(x=sum_Flights, y=propOfDelay)) +
  geom_point() +
  ggtitle("% of Delays By Total Flights") 


dfSummaryStats_OutliersRemoved <- dfSummaryStats %>%
  filter(sum_Flights<2000)

g5<-ggplot(dfSummaryStats_OutliersRemoved, aes(x=sum_Flights, y=propOfDelay)) +
  geom_point() +
  ggtitle("% of Delays By Total Flights _ outliers removed") 

grid.arrange(g4, g5, ncol=2)
```

```{r regression}

lmHeight = lm(sum_Flights~propOfDelay, data = dfSummaryStats_OutliersRemoved) #Create the linear regression
summary(lmHeight) #Review the results


```

Neither of the graphs nor the regression analysis suggest that % of delays is correlated with number of flights.  

Perhaps it's something more sinister.  Is it possible there is some kind of favoritism going on among airport staff and crew?  There is no easy way to measure that directly, but as an albeit weak proxy we observe that Phoenix appears to be some kind of hub for Amwest and Seattle a hub for Alaska:

```{r traffic}

g3<-ggplot(dfFlights, aes(x=City, y=NumOfFlights, group=Airline, fill=Airline)) +
  geom_col(position = position_dodge()) +
  ggtitle("Number of Flights By Airline By City") +
  theme(axis.text.x = element_text(angle = 90))
g3
```

While Amwest has a higher percentage of delays across the board, is the gap between Amwest's and Alaska's delay percentages lowest in Phoenix and highest in Seattle?  This might suggest that where Amwest is most prominent they get favored treatment by the airport, and where Alaska is most prominent Amwest gets the least favored treatment.


This barchart shows the difference in the % delays between the two airlines, by city.  

```{r diff 2}

g2<-ggplot(dfPercentDiff, aes(x=City, y=propDiff)) +
  geom_col(position = position_dodge()) +
  ggtitle("Diff in % of Delays By City") +
  theme(axis.text.x = element_text(angle = 90))
g2

```


Amwest clearly does best in Phoenix relative to Alaska, and very poorly in Seattle, but the biggest difference is in San Francisco where they have MORE total flights than Alaska.  Could it be the weather? Amwest does worst in the Northern cities - but at this point there is too little data to determine.  Besides, blaming it on the weather, while we have all done it, is hardly a viable excuse.

### Conclusion

Amwest filed for bankruptcy in the early ninieties and eventually was swallowed up by US Air. This is a prophetic story.  Had they employed data scientists who could have shown them the above charts they might have survived to this day.
