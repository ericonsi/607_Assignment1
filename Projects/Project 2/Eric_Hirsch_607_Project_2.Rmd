---
title: "Eric_Hirsch_607_Project_2"
author: "Eric Hirsch"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, message=FALSE}
library(openintro)
library(tinytex)
library(tidyverse)
library(stringr)
library(magrittr)
library(gridExtra)
library(readxl)
```

## Using TidyR and Dyplr for Data Transformation

#### Introduction 

In this project we will transform a csv file into a usable dataframe using TidyR and Dyplr. After the transformation we will conduct some analyses.

First we load the data: 

``` {r load data}
dfBLS_raw <- read.delim("https://raw.githubusercontent.com/ericonsi/CUNY_607/main/Projects/Project%202/bls-2020.csv", sep=",")

```
A. Headers are no good
B. How to separate out the demographic sections
C. Need to create "other" for race

1. Drop the totals column

```{r drop totals column}

dfBLS <- dfBLS_raw %>%
  select(-"X")
```

2. Add the year

```{r add year}

dfBLS %<>%
  mutate(Year = "2015") 
```

3. Fix the column names
  a. Get a vector for the column names from the row tht contains them
  b. Clean the column names by replacing the hyphens and paragraph breaks, taking out 'occupations', etc.
  c. rename the columns using the vector

```{r columns}

vColumnNames <- as.character(dfBLS %>%
  filter(row_number() %in% 5) %>%
  select(-contains("Household") & -"Year"))

vColumnNames = str_replace_all(vColumnNames, "[\r\n]", " ")
vColumnNames = str_replace_all(vColumnNames, "-   ", "")
vColumnNames = str_replace_all(vColumnNames, "- ", "")
vColumnNames = str_replace_all(vColumnNames, "  ", "")
vColumnNames = str_replace_all(vColumnNames, " occupations", "")

dfBLS %<>%
  rename(Industry = contains("Household"), !!vColumnNames[1] := X.1, !!vColumnNames[2] := X.2, !!vColumnNames[3] := X.3, !!vColumnNames[4] := X.4, !!vColumnNames[5] := X.5, !!vColumnNames[6] := X.6, !!vColumnNames[7] := X.7, !!vColumnNames[8] := X.8, !!vColumnNames[9] := X.9, !!vColumnNames[10] := X.10, !!vColumnNames[11] := X.11)
```

4. Extract the data into the 5 demographic units (female, male, Black, white and asian)
  a. select rows using 'filter'
  b. add the relevant demographic info as a column (.e.g Gender or Race)
  c. Handling rows which merely summarize other rows
    1. Remove the summary row
    s. Rename the remaining rows where necessary
  c. gather columns(using handy vector names column) to convert from wide to long
 

```{r filter into demographic units}

DemographicUnit <- function(df, rowStart, rowEnd, demoCategory, demoContent)
{
  
dfNew <- df %>% 
  filter(row_number() %in% rowStart:rowEnd) %>%
  mutate(!!demoCategory := demoContent) %>%
  filter(Industry !="Manufacturing" & Industry !="Wholesale and retail trade" & Industry !="Other services") %>%
  gather(vColumnNames,  key="Occupation", value="NumberEmployed")

  dfNew$NumberEmployed = str_replace_all(dfNew$NumberEmployed, ",", "")
  dfNew <- mutate_at(dfNew, vars(NumberEmployed), list(as.integer)) %>%
  mutate(RowID = row_number())

  dfNew$Industry = str_replace_all(dfNew$Industry, "Durable goods", "Manufacturing, durable goods")
  dfNew$Industry = str_replace_all(dfNew$Industry, "Nondurable goods", "Manufacturing, nondurable goods")
  dfNew$Industry = str_replace_all(dfNew$Industry, "Private households", "Other services, private households only")

return (dfNew)
}

dfBLS_Men = DemographicUnit(dfBLS, 29, 47, "Gender", "Male")
dfBLS_Women = DemographicUnit(dfBLS, 50, 68, "Gender", "Female")
dfBLS_White = DemographicUnit(dfBLS, 71, 89, "Race", "White")
dfBLS_Black = DemographicUnit(dfBLS, 92, 110, "Race", "Black")
dfBLS_Asian = DemographicUnit(dfBLS, 113, 131, "Race", "Asian")
dfBLS_Total = DemographicUnit(dfBLS, 8, 26, "Race", "Total")

  
```
5. Create the Race and Gender dataframes:

```{r cr}
dfRace <- rbind(dfBLS_Black, dfBLS_White, dfBLS_Asian, dfBLS_Total)
dfGender <- rbind(dfBLS_Women, dfBLS_Men)

```

6. Create the "Other Race" unit within the race dataframe by comparing the three race units to the total
  a. spread the dataframe using TidyR so each race is a column
  b. Create a category called "Other" which is the Total minus the other categories
  b. Eliminate the total category
  c. Re-gather the dataframe by race
  

```{r Other Race}

dfRace %<>% 
  spread(Race, NumberEmployed) %<>%
  mutate_at(vars(Black, White, Asian, Total), list(as.numeric)) %<>%
  mutate(Other = Total-(Black + White + Asian)) %<>%
  select(-"Total") %<>%
  gather(Black, White, Asian, Other, key="Race", value="NumberEmployed")

```

## Analysis

```{r}
g3<-ggplot(dfGender, aes(x=Industry, y=NumberEmployed, group=Gender, fill=Gender)) +
  geom_col(position = position_dodge()) +
  ggtitle("Number Employed by Industry and Gender") +
  theme(axis.text.x = element_text(angle = 90)) +
  coord_flip()
g3


```
```{r}

dfInfoGender=dfGender %>%
  filter(Industry=="Information") %>%
  group_by(Occupation) %>%
    summarize(n=n(), percentEmployed = sum(NumberEmployed/n))
  
dfInfoRace=dfRace %>%
  filter(Industry=="Information")


  g5<-ggplot(dfInfoGender, aes(x=Occupation, y=percentEmployed, group=Gender, fill=Gender)) +
  geom_col(position = position_dodge()) +
  ggtitle("Percent Employed in Information by Gender") +
    coord_flip()
g5

  g3<-ggplot(dfInfo, aes(x=Occupation, y=NumberEmployed, group=Gender, fill=Gender)) +
  geom_col(position = position_dodge()) +
  ggtitle("Number Employed in Information by Gender") +
    coord_flip()
  
g3  
    g4<-ggplot(dfInfoRace, aes(x=Occupation, y=NumberEmployed, group=Race, fill=Race)) +
  geom_col(position = position_dodge()) +
  ggtitle("Number Employed in Information by Race") +
  theme(axis.text.x = element_text(angle = 90))  +
      coord_flip()
g4
```

