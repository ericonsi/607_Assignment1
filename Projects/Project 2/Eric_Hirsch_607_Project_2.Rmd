---
title: "Eric_Hirsch_607_Project_2"
author: "Eric Hirsch"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, message=FALSE}
library(openintro)
library(tinytex)
library(tidyverse)
library(stringr)
library(magrittr)
library(gridExtra)
```

## Using TidyR and Dyplr for Data Transformation

#### Introduction 

In this project we will transform a csv file into a usable dataframe using TidyR and Dyplr. After the transformation we will conduct some analyses.

Loading the data:

``` {r load data}
dfFlights_raw <- as.data.frame(read.delim("https://raw.githubusercontent.com/ericonsi/CUNY_607/main/Projects/Project%202/Flights.csv", header = TRUE, stringsAsFactors = TRUE, sep=","))
```

We will also eliminate the unneccesary row and change some column names:

```{r bvkf}
dfFlights <- dfFlights_raw %>% 
  drop_na(Phoenix) %>%
  rename(c(Airline =  "X", Status = "X.1")) %>%
  mutate_all(list(~na_if(.,"")))

head(dfFlights)
```


  
1. We use TidyR to normalize the table

```{r agfd}

dfFlights %<>%
  gather("Los.Angeles", "Phoenix", "San.Diego", "San.Francisco", "Seattle", key="City", value="NumOfFlights") %<>%
  fill(Airline)
  #spread(Status, "NumOfFlights")

```

2. Now we can analyse the data.


``` {r plot average by fiter}

EH_PlotAverageNumberOfFlights<- function(df, groupBy, title, reorder=TRUE)
{

  xx <- df %>% 
  group_by_(groupBy) %>% 
  summarize(ave_NumOfFlights=mean(NumOfFlights), n=n()) %>%
  mutate(tmp = fct_reorder(.[[groupBy]], ave_NumOfFlights)) %>%
  mutate(labelx = str_c(round(ave_NumOfFlights, digits=2), "  (", n, ")"))
  
  if(!reorder) {xx$tmp = as.character(xx$tmp)}
  
g <- ggplot(xx, aes_string(x = "tmp", y = "ave_NumOfFlights")) + 
  geom_col(position = position_dodge(), width=.8, color = "#261d11", fill = "#912742") + 
  xlab(groupBy) + 
  ylab("Average Number of Flights") +
  ggtitle(title) +
  coord_flip() +
  ylim(0,5) +
  geom_text(aes(label = labelx), size = 3 , hjust = -.3)

return(g)
}
```

```{r dg}

EH_PlotAverageScore_2<- function(df, groupBy1, groupBy2, title="")
{
  group <- c(groupBy1,groupBy2) 
  
xqx <- df %>% 
  group_by_(.dots = group) %>% 
  summarize(ave_Flights=mean(NumOfFlights), n=n())

g <- ggplot(xqx, aes_string(x = groupBy1, y = "ave_Flights", group=groupBy2, fill=groupBy2)) + 
  geom_col(position = position_dodge(), width=.8, color = "black") + 
  xlab(groupBy1) + ylab("Average Number of Flights") +
  ggtitle(title) +  
  coord_flip() +
  scale_fill_brewer(palette="Spectral") +
  theme(legend.position="bottom")

return(g)

}
```
```{r pol}
EH_PlotAverageScore_2(dfFlights, "Airline", "Status")
EH_PlotAverageScore_2(dfFlights, "City", "Status")
EH_PlotAverageNumberOfFlights(dfFlights, "City", "By City")

ggplot(dfFlights, aes(x=City, y=NumOfFlights, group=Airline, fill=Airline)) +
  geom_col(position = position_dodge())

ggplot(dfFlights, aes(x=Airline, y=NumOfFlights, group=Status, fill=Status)) +
  geom_col(position = position_dodge())


  
xqx <- dfFlights %>% 
  group_by(Airline, City) %>% 
  summarize(ave_Flights=mean(NumOfFlights), propOfDelay=sum(NumOfFlights[Status=="delayed"])/sum(NumOfFlights))

ggplot(xqx, aes(x=City, y=propOfDelay, group=Airline, fill=Airline)) +
  geom_col(position = position_dodge())

ggplot(xqx, aes(x=City, y=propOfDelay)) +
  geom_boxplot()

asd <- dfFlights %>%
  filter(Status=="delayed")

ggplot(asd, aes(x=NumOfFlights)) +
  geom_histogram()



```


EH_PlotAverageScore_2<- function(df, groupBy1, groupBy2, title)
{

There are a number of interesting findings here. First, as strength of opponents increases, the number of wins also increases.  This counterintuitive finding may suggest that the best players are being paired with the other good players, but they are nonetheless dominating them.  We can also see some outliers.  For example, on the one-win boxplot we see Ethan G, a low ranked player who faced some of the strongest opponents. At the time same time we see Michael M only score 1 win against some of the easiest opponents.

### Conclusion

R has many tools for cleaning up messy files.  We used stringr, purrr, dyplr and other libraries to accomplish this task.  As a beginner to R I'm confident there are more robust solutions than mine - but it is encouraging to know how much can be done with so few lines of code!



